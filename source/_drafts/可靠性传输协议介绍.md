---
title: 可靠性传输协议介绍
tags:
  - 网络基础
category:
  - network
date: 2021-04-15 14:53:33
---

我们知道在互联网的信道上可能出现包丢失，包乱序，包重复等现象，在这种情况下我们应该如何保证数据包的正确性呢，这里介绍三种基础的可靠性协议。

## 停止-等待协议

停止-等待协议如下图所示

![20210415150416](https://blog.abely.store/blog/20210415150416.svg)

<!--more-->

如上图所示，停止-等待协议比较简单，只有收到服务端的ack包之后，才会发送下个包。

### 包损坏

如果服务端收到了`packet 0`，如果检查发现包损坏，可以选择返回NACK包，表示需要重发此包 。如果信道丢失率较高，我们一般不会使用此方法，因为NACK包也可能丢失。

### 包丢失

上面也说到，如果信道的丢失率较高，那么超时重发是一个不错的选择，一般来说，超时时间需要略大于一个RTT(一个包往返时延)时间。

### 包乱序

因为包是一个一个发过去的，不存在包乱序问题。

### 包重复

如果一个包的ACK消息丢失，那么客户端会重传包，服务端会再次收到上次的包，服务端需要记得这个包并丢弃此包，这里就需要给包设置一个序列号，服务端就会知道这个包不是要接收的包。因为包是一个一个发，所以序列号只需要1个bit，表示0/1即可解决问题。

### 问题

很明显，信道的利用率很低。

## 回退N帧协议

![](https://blog.abely.store/blog/20210415152317.svg)

回退N帧协议和停止-等待协议的主要区别是可以一次性发送多个数据报文，不过有几个点需要注意下：

- 服务端的接收窗口恒定为1，也就是如果packet 1先于packet 0达到，那么packet 1直接被丢弃，客户端会发现等不到ack 1，那么超时重发(同理，因为packet 1被丢弃，那么服务端接收packet 0后，packet 2到达还是会被丢弃)。
- 累计确认功能，如果客户端收到ack2，那么意味着packet 0，packet 1，packet 2都已经被服务端正确接收。所以，在这种情况下，服务端不需要对每个包做一次ACK。

### 包乱序

上面也说过，如果一个包先于前一个包到达则会被丢弃。

### 窗口大小问题



### 问题

如果传输过程中，丢失了一个包，其后面的包即使正确到达也不会被接收，无意浪费了信道的带宽，在信道可靠性低时，利率用也是很低。

## 选择重传协议

选择重传协议是在回退N帧的基础上，服务端也有个窗口，只要在窗口内的包都可以被接收，即使没有按序到达。不过这种情况下，就不能支持累计确认功能，每个包都是独立的个体，需要对应的ACK表示其接收状态。

