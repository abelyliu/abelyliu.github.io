---
title: 为什么需要事务
date: 2017-02-08 11:48:18
tags: Database
category: 随想
---

数据库是面向多用户的，所以需要解决数据的同步问题，这是显而易见的。对数据库而言，所有的操作都需要事务的，就算我们没有明确声明过。

![](/images/65.png)

我们使用数据库管理工具一般会看到如上的选项，其实auto-commit就是控制事务的选项，如果勾选后，每条SQL都是独立的事务，否则必须明确使用commit/rollback命令，SQL的修改才会对数据库生效。

既然事务是针对数据库并发而使用的，让我们看看在不使用事务(使用auto-commit)的情况下会出现那些问题吧？

<!--more-->

## 脏读
**脏读是指一个事务能够读取另一个事务未提交的数据。**

![](/images/66.png)

我们看上图，如果我们在`1`这个位置去读取x，那么x应该为多少？我们应该希望x=1，但如果A不在事务的控制中，就会出现问题，也就是脏读。

## 不可重复读

![](/images/67.png)

我们同样在`1`这个地方操作，如果这时候任务B需要将x+100，那么任务A和任务B都执行完成后数据中x应该为多少？此时，任务B就不能简单的读取任务A执行之前的值，而是需要等到任务A执行完毕后才能开始任务B。

## 幻读

幻读和不可重复读的区别在于:不可重复读是针对同一行数据，也就是update操作；幻读是针对insert和delete操作，下面是*深入浅出Mybatis技术原理与实战*关于幻读的例子：

时刻|事务A|事务B|说明
:---:|:---:|:---:|:---:
T1|老婆查询当月银行账户支出1000元|－|初始状态
T2|－|老公消费800|老公此时消费
T3|－|老公提交修改|事务被提交
T4|老婆打印账单为1800|－|前后差异，老婆以为800元是幻读

幻读和不可重复读都是读取时数据被修改，为什么要区分幻读和不可重复读呢？

如果是不可重复读，我们只要锁上读取行即可，幻读会添加或删除行，就需要更大级别的锁。因为这两种情况需要的锁不同，对应的开销也不同，所以区分这两种问题。

## 参考链接
1. [数据库并发时如何保证数据的正确性？](https://www.zhihu.com/question/29322320)
2. [数据库并发控制技术](http://blog.csdn.net/yanglilibaobao/article/details/1670026)
3. [不可重复读和幻读的区别](http://www.cnblogs.com/itcomputer/articles/5133254.html)
4. 深入浅出Mybatis技术原理与实战